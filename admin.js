import{db as e,collection as t,getDocs as n,addDoc as a,query as s,where as d,doc as o,setDoc as r,deleteDoc as i}from"./firebase-init.js";const c={cache:{teachers:null,classrooms:null,attendance:null},async getAttendanceByDate(a){try{const o=s(t(e,"attendance"),d("date","==",a)),r=await n(o),i=[];return r.forEach(e=>{i.push({id:e.id,...e.data()})}),i}catch(e){return[]}},async getAttendanceByRange(a,o){try{const r=s(t(e,"attendance"),d("date",">=",a),d("date","<=",o)),i=await n(r),c=[];return i.forEach(e=>{c.push({id:e.id,...e.data()})}),c}catch(e){return[]}},async getOffDaysByDate(a){try{const o=s(t(e,"offDays"),d("date","==",a)),r=await n(o),i=[];return r.forEach(e=>{i.push({id:e.id,...e.data()})}),i}catch(e){return[]}},async getTeacherOffDaysByDate(a){try{const o=s(t(e,"teacherOffDays"),d("date","==",a)),r=await n(o),i=[];return r.forEach(e=>{i.push({id:e.id,...e.data()})}),i}catch(e){return[]}},async get(a){if("attendance"!==a&&this.cache[a])return this.cache[a];try{const s=await n(t(e,a)),d=[];return s.forEach(e=>{d.push({id:e.id,...e.data()})}),this.cache[a]=d,d}catch(e){return[]}},async add(n,s){try{let d;return s.id&&"attendance"!==n?(await r(o(e,n,String(s.id)),s),d={id:String(s.id)}):d=await a(t(e,n),s),this.cache[n]=null,d.id}catch(e){throw e}},async delete(t,n){try{await i(o(e,t,String(n))),this.cache[t]=null}catch(e){throw e}},async seedIfEmpty(){if(0===(await this.get("teachers")).length){const e=l.getTodayDate(),t=[{id:"101",name:"John Smith",subject:"Mathematics",dateAdded:e,createdAt:(new Date).toISOString()},{id:"102",name:"Sarah Johnson",subject:"Science",dateAdded:e,createdAt:(new Date).toISOString()}];for(const e of t)await this.add("teachers",e);const n=[{id:"C001",name:"Grade 10A",subject:"General"},{id:"C002",name:"Grade 10B",subject:"General"}];for(const e of n)await this.add("classrooms",e)}}},l={chart:null,getTodayDate(){const e=new Date;return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`},async init(){sessionStorage.getItem("isLoggedIn")?this.navigateTo("dashboard"):this.navigateTo("login");const e=this.getTodayDate(),t=document.getElementById("stats-date");t&&!t.value&&(t.value=e);const n=document.getElementById("matrix-date");n&&!n.value&&(n.value=e),await this.populateTeacherSelect(),await c.get("classrooms"),c.seedIfEmpty()},async populateTeacherSelect(){const e=document.getElementById("stats-teacher-select");if(!e||e.options.length>1)return;const t=await c.get("teachers");t.sort((e,t)=>e.name.localeCompare(t.name)),t.forEach(t=>{const n=document.createElement("option");n.value=t.id,n.textContent=t.name,e.appendChild(n)})},navigateTo(e){document.querySelectorAll(".view").forEach(e=>e.classList.add("hidden"));const t=document.getElementById(`view-${e}`);t&&t.classList.remove("hidden"),"dashboard"===e&&this.renderDashboard()},authorizedEmails:["raashid.mm@gmail.com","raashidmansoor@gmail.com","relaugh@gmail.com","safwanmoha@gmail.com","uzmannazlin76@gmail.com"],handleGoogleLogin(e){if(e.credential){const t=JSON.parse(atob(e.credential.split(".")[1])).email;if(!this.authorizedEmails.includes(t))return void alert(`Access Denied!\n\nYour email (${t}) is not authorized to access this system.\n\nPlease contact the administrator.`);sessionStorage.setItem("isLoggedIn","true"),sessionStorage.setItem("userEmail",t),this.navigateTo("dashboard")}},logout(){sessionStorage.removeItem("isLoggedIn"),sessionStorage.removeItem("userEmail"),this.navigateTo("login")},switchTab(e){document.querySelectorAll(".tab-content").forEach(e=>e.classList.add("hidden")),document.querySelectorAll(".nav-link").forEach(e=>e.classList.remove("active")),document.getElementById(`content-${e}`).classList.remove("hidden"),document.getElementById(`tab-${e}`).classList.add("active"),"overview"!==e&&"dashboard"!==e||this.renderOverview(),"class"===e&&this.renderMatrix(),"teachers"===e&&this.renderTeacherStats(),"admin"===e&&this.renderAdmin()},async renderTeacherStats(){const e=document.getElementById("stats-date");e.value||(e.value=this.getTodayDate());const t=e.value,n=document.getElementById("stats-teacher-select");await this.populateTeacherSelect(),!n.value&&n.options.length>1&&(n.selectedIndex=1);const a=n.value;if(!a)return;const s=await c.getAttendanceByDate(t),d=document.querySelector("#stats-daily-table tbody");d.innerHTML="";Schedule.getPeriods(new Date(t)).filter(e=>"break"!==e.type).forEach(e=>{const t=s.find(t=>t.teacherId===a&&String(t.period)===String(e.id));let n="-",o="-",r="-";if(t){const a=new Date(t.timestamp);n=a.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),r=t.className||"-";const s=Schedule.calculateStatus(e,a).delayMins;o=s<=5?'<span class="font-bold text-green-600">On time</span>':s<=15?`<span class="font-bold text-yellow-600">${s} minutes</span>`:`<span class="font-bold text-red-600">${s} minutes</span>`}d.innerHTML+=`\n                <tr>\n                    <td class="font-medium">${e.name}</td>\n                    <td>${r}</td>\n                    <td class="font-bold">${n}</td>\n                    <td>${o}</td>\n                </tr>\n            `});const o=new Date;let r=new Date;r.setDate(1);const i=r.toLocaleDateString("en-CA"),l=o.toLocaleDateString("en-CA"),m=(await c.getAttendanceByRange(i,l)).filter(e=>e.teacherId===a);let h=0,u=0,f=0;m.forEach(e=>{const t=new Date(e.timestamp),n=Schedule.getPeriods(t).find(t=>String(t.id)===String(e.period));if(n&&"break"!==n.type){const e=Schedule.calculateStatus(n,t).delayMins;e<=5?h++:e<=15?u++:f++}}),document.getElementById("summary-on-time").textContent=h,document.getElementById("summary-late-10").textContent=u,document.getElementById("summary-late-20").textContent=f},async renderMatrix(){const e=document.getElementById("matrix-grade").value,t=document.getElementById("matrix-date").value||this.getTodayDate();document.getElementById("matrix-date").value=t;const n=await c.get("classrooms"),a=await c.getAttendanceByDate(t),s=n.filter(t=>!e||t.name.includes(`Grade ${e}`));s.sort((e,t)=>e.name.localeCompare(t.name,void 0,{numeric:!0,sensitivity:"base"}));const d=document.querySelector("#matrix-table tbody"),o=document.querySelector("#matrix-table thead tr"),r=Schedule.getPeriods(new Date(t)).filter(e=>"break"!==e.type);let i="<th>Class</th>";r.forEach(e=>{i+=`<th>P${e.id}</th>`}),o.innerHTML=i,d.innerHTML="",s.forEach(e=>{let t=`<tr><td class="font-bold">${e.name}</td>`;r.forEach(n=>{const s=a.find(t=>t.className===e.name&&String(t.period)===String(n.id));if(s){const e=new Date(s.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),n="Late"===s.status?"text-red-600":"text-green-600";t+=`\n                        <td class="text-xs">\n                            <div class="font-bold">${s.teacherName}</div>\n                            <div class="${n}">${e}</div>\n                        </td>\n                    `}else t+="<td></td>"}),t+="</tr>",d.innerHTML+=t})},renderDashboard(){this.renderOverview(),this.dashboardInterval&&clearInterval(this.dashboardInterval),this.dashboardInterval=setInterval(()=>{document.getElementById("content-overview")&&!document.getElementById("content-overview").classList.contains("hidden")&&this.renderOverview()},3e4)},async renderOverview(){const e=await c.get("teachers"),t=await c.get("classrooms"),n=this.getTodayDate(),a=await c.getAttendanceByDate(n),s=document.getElementById("dashboard-filter")?document.getElementById("dashboard-filter").value:"today";let d=[];if("today"===s)d=a;else{const e=new Date;let t=new Date;"weekly"===s?t.setDate(e.getDate()-7):t.setDate(1);const n=t.toLocaleDateString("en-CA"),a=e.toLocaleDateString("en-CA");d=await c.getAttendanceByRange(n,a)}const o=new Set(d.map(e=>e.teacherId)),r=d.filter(e=>"On Time"===e.status).length,i=d.filter(e=>"Late"===e.status).length;let l=0;if("today"===s){const e=new Date,n=Schedule.getPeriods(e).filter(e=>"break"!==e.type).filter(t=>{const[n,a]=t.end.split(":").map(Number),s=new Date(e);return s.setHours(n,a,0,0),e>s});for(const e of n){const n=new Set(a.filter(t=>String(t.period)===String(e.id)).map(e=>e.className));l+=t.length-n.size}}else l=Math.max(0,e.length-o.size);document.getElementById("stat-on-time").textContent=r,document.getElementById("stat-late").textContent=i,document.getElementById("stat-absent").textContent=l;const m=Schedule.getCurrentPeriod(),h=document.getElementById("current-period-badge"),u=document.getElementById("unattended-list");if(u.innerHTML="",m&&"break"!==m.type){h.textContent=m.name,h.className="px-2 py-1 bg-green-100 text-green-800 rounded text-xs font-bold";const e=new Set(a.filter(e=>String(e.period)===String(m.id)).map(e=>e.className)),n=t.filter(t=>!e.has(t.name)).sort((e,t)=>e.name.localeCompare(t.name,void 0,{numeric:!0,sensitivity:"base"}));0===n.length?u.innerHTML='<div class="text-green-600 text-sm col-span-full text-center py-4 font-bold">\n                    <i class="fas fa-check-circle"></i> All classes attended!\n                </div>':n.forEach(e=>{const t=document.createElement("div");t.className="p-2 bg-red-50 border border-red-100 rounded text-center text-red-700 font-bold text-sm",t.textContent=e.name,u.appendChild(t)})}else h.textContent=m?m.name:"After Hours",h.className="px-2 py-1 bg-gray-200 rounded text-xs font-bold text-gray-600",u.innerHTML=`<div class="text-gray-500 text-sm col-span-full text-center py-4">\n                ${m?"Currently in Break/Interval":"School is closed"}\n            </div>`;const f=document.getElementById("recent-activity-list");f.innerHTML="";const g=[...a].sort((e,t)=>t.timestamp-e.timestamp).slice(0,5);0===g.length?f.innerHTML='<div class="text-gray-400 text-sm text-center">No activity today</div>':g.forEach(e=>{const t=new Date(e.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});f.innerHTML+=`\n                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">\n                        <div>\n                            <div class="font-bold text-sm">${e.teacherName}</div>\n                            <div class="text-xs text-gray-500">${e.className} • ${e.subject}</div>\n                        </div>\n                        <div class="text-right">\n                            <div class="font-bold text-sm">${t}</div>\n                            <div class="text-xs ${"Late"===e.status?"text-red-600":"text-green-600"}">${e.status}</div>\n                        </div>\n                    </div>\n                `})},async renderAdmin(){const e=await c.get("teachers"),t=document.querySelector("#teachers-table tbody");t.innerHTML="",e.forEach(e=>{t.innerHTML+=`\n                <tr>\n                    <td>${e.id}</td>\n                    <td>${e.name}</td>\n                </tr>\n            `});const n=await c.get("classrooms"),a=document.querySelector("#classrooms-table tbody");a.innerHTML="",n.forEach(e=>{a.innerHTML+=`\n                <tr>\n                    <td>${e.name}</td>\n                    <td>\n                        <button onclick="app.showQR('${e.id}')" class="text-blue-600" title="View QR Code">\n                            <i class="fas fa-qrcode"></i>\n                        </button>\n                        <button onclick="app.downloadQR('${e.id}')" class="text-green-600 ml-2" title="Download QR Code">\n                            <i class="fas fa-download"></i>\n                        </button>\n                    </td>\n                </tr>\n            `});const s=document.getElementById("off-day-class");if(s){const e=Array.from(s.options).map(e=>e.value);n.forEach(t=>{if(!e.includes(t.id)){const e=document.createElement("option");e.value=t.id,e.textContent=t.name,s.appendChild(e)}})}const d=document.getElementById("off-teacher-id");d&&(d.innerHTML='<option value="" disabled selected>Select a Teacher</option>',e.forEach(e=>{const t=document.createElement("option");t.value=e.id,t.textContent=`${e.name} (ID: ${e.id})`,d.appendChild(t)})),await this.renderOffDaysList(),await this.renderTeacherOffDaysList()},openModal(e){document.getElementById("modal-overlay").classList.add("active");const t=document.getElementById("modal-fields");t.dataset.type=e,document.getElementById("modal-title").textContent="teacher"===e?"Add Teacher":"Add Classroom",t.innerHTML="teacher"===e?'\n                <input type="number" name="id" class="input" placeholder="Teacher ID (e.g. 101)" required inputmode="numeric">\n                <input type="text" name="name" class="input" placeholder="Full Name" required>\n                <input type="text" name="subject" class="input" placeholder="Subject" required>\n            ':'\n                <input type="text" name="id" class="input" placeholder="Class ID (e.g. C001)" required>\n                <input type="text" name="name" class="input" placeholder="Class Name (e.g. Grade 10A)" required>\n            '},closeModal(){document.getElementById("modal-overlay").classList.remove("active")},async handleModalSubmit(e){e.preventDefault();const t=document.getElementById("modal-fields"),n=t.dataset.type,a=t.querySelectorAll("input"),s={};a.forEach(e=>s[e.name]=e.value);const d="teacher"===n?"teachers":"classrooms";"teacher"===n&&(s.createdAt=(new Date).toISOString(),s.dateAdded=this.getTodayDate());try{await c.add(d,s),this.closeModal(),this.renderAdmin()}catch(e){alert("Error saving data: "+e.message)}},async deleteItem(e,t){if(confirm("Are you sure?"))try{await c.delete(e,t),this.renderAdmin()}catch(e){alert("Error deleting: "+e.message)}},resetSystem(){confirm("DANGER: This will wipe all local data (not cloud). Continue?")&&(localStorage.clear(),location.reload())},async populateClasses(){if(!confirm("This will add classes from Grade 6 to 11 (Sections A-E2). Continue?"))return;const e=[6,7,8,9,10,11],t=["A","B","C","D","E1","E2"];let n=0,a=1;try{for(const s of e)for(const e of t){const t=`Grade ${s}${e}`,d=`C${String(a++).padStart(3,"0")}`;await c.add("classrooms",{id:d,name:t}),n++}alert(`Successfully added ${n} classes!`),this.renderAdmin()}catch(e){alert("Error populating classes: "+e.message)}},async cleanupAndResetDatabase(){if(confirm("⚠️ This will DELETE ALL existing data and create fresh records with new 3-digit teacher IDs. This cannot be undone. Continue?"))try{const a=await n(t(e,"teachers"));let s=0;for(const t of a.docs)await i(o(e,"teachers",t.id)),s++;const d=await n(t(e,"classrooms"));s=0;for(const t of d.docs)await i(o(e,"classrooms",t.id)),s++;const c=await n(t(e,"attendance"));s=0;for(const t of c.docs)await i(o(e,"attendance",t.id)),s++;const l=this.getTodayDate(),m=(new Date).toISOString(),h=[{id:"101",name:"Mr. Ahmed",subject:"Mathematics",dateAdded:l,createdAt:m},{id:"102",name:"Ms. Fatima",subject:"Science",dateAdded:l,createdAt:m},{id:"103",name:"Mr. Rizwan",subject:"English",dateAdded:l,createdAt:m},{id:"104",name:"Ms. Ayesha",subject:"History",dateAdded:l,createdAt:m},{id:"105",name:"Mr. Zaid",subject:"Geography",dateAdded:l,createdAt:m}];for(const t of h)await r(o(e,"teachers",t.id),t);const u=[6,7,8,9,10,11],f=["A","B"];let g=0;for(const t of u)for(const n of f){const a={id:`G${t}${n}`,name:`Grade ${t}${n}`,subject:"General"};await r(o(e,"classrooms",a.id),a),g++}alert(`✅ Database cleaned up successfully!\n\nCreated:\n- ${h.length} teachers (IDs: 101-105)\n- ${g} classrooms\n\nPlease refresh the page.`),this.renderAdmin()}catch(e){alert(`Error: ${e.message}\n\nCheck the console for details.`)}},async generateSampleData(){if(confirm("This will generate comprehensive sample data (Teachers, Classes, Attendance) for the last 7 days. Continue?"))try{const t=this.getTodayDate(),n=(new Date).toISOString(),a=[{id:"101",name:"Mr. Ahmed",subject:"Mathematics",dateAdded:t,createdAt:n},{id:"102",name:"Ms. Fatima",subject:"Science",dateAdded:t,createdAt:n},{id:"103",name:"Mr. Rizwan",subject:"English",dateAdded:t,createdAt:n},{id:"104",name:"Ms. Ayesha",subject:"History",dateAdded:t,createdAt:n},{id:"105",name:"Mr. Zaid",subject:"Geography",dateAdded:t,createdAt:n}];for(const t of a)await r(o(e,"teachers",t.id),t);let s=await c.get("classrooms");if(s.length<5){const t=[{id:"C_TEST_01",name:"Grade 10A"},{id:"C_TEST_02",name:"Grade 10B"},{id:"C_TEST_03",name:"Grade 11A"},{id:"C_TEST_04",name:"Grade 9C"}];for(const n of t)await r(o(e,"classrooms",n.id),n);s=[...s,...t]}const d=new Date;let i=0;for(let e=0;e<7;e++){const t=new Date(d);t.setDate(t.getDate()-e);const n=t.toLocaleDateString("en-CA");if(0===t.getDay()||6===t.getDay())continue;const o=Schedule.getPeriods(t).filter(e=>"break"!==e.type);for(const e of a)for(const a of o){if(Math.random()<.15)continue;const d=s[Math.floor(Math.random()*s.length)],o=Math.random();let r=0,l="On Time";o<.7?r=Math.floor(5*Math.random()):o<.9?(r=6+Math.floor(10*Math.random()),l="Late"):(r=16+Math.floor(15*Math.random()),l="Late");const[m,h]=a.start.split(":").map(Number),u=new Date(t);u.setHours(m,h+r,0);const f={id:Date.now()+Math.random(),teacherId:e.id,teacherName:e.name,className:d.name,subject:e.subject,period:a.id,timestamp:u.getTime(),date:n,status:l};await c.add("attendance",f),i++}}alert(`Generated ${i} attendance records for the last week!`),location.reload()}catch(e){alert("Error generating data: "+e.message)}},async showQR(e){const t=(await c.get("classrooms")).find(t=>t.id===e);if(!t)return;const n=document.createElement("div");n.id="qr-overlay",n.style.cssText="\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: rgba(0,0,0,0.9);\n            z-index: 10000;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            padding: 20px;\n        ";const a=()=>{const e=document.getElementById("qr-overlay");e&&e.remove()};n.innerHTML=`\n            <div id="qr-poster-content" style="\n                background: white;\n                width: 210mm;\n                height: 297mm;\n                padding: 40px;\n                box-shadow: 0 10px 50px rgba(0,0,0,0.5);\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                justify-content: center;\n                position: relative;\n                font-family: 'Inter', sans-serif;\n            ">\n                \x3c!-- Action Buttons Container --\x3e\n                <div style="\n                    position: absolute;\n                    top: 20px;\n                    left: 20px;\n                    right: 20px;\n                    display: flex;\n                    justify-content: space-between;\n                    align-items: center;\n                ">\n                    \x3c!-- Left buttons --\x3e\n                    <div style="display: flex; gap: 10px;">\n                        <button id="download-qr-btn" style="\n                            background: #059669;\n                            color: white;\n                            border: none;\n                            padding: 10px 20px;\n                            border-radius: 8px;\n                            font-size: 14px;\n                            cursor: pointer;\n                            box-shadow: 0 2px 10px rgba(0,0,0,0.2);\n                            display: flex;\n                            align-items: center;\n                            gap: 8px;\n                        ">\n                            <i class="fas fa-download"></i> Download QR\n                        </button>\n                        <button onclick="window.print()" style="\n                            background: #003366;\n                            color: white;\n                            border: none;\n                            padding: 10px 20px;\n                            border-radius: 8px;\n                            font-size: 14px;\n                            cursor: pointer;\n                            box-shadow: 0 2px 10px rgba(0,0,0,0.2);\n                            display: flex;\n                            align-items: center;\n                            gap: 8px;\n                        ">\n                            <i class="fas fa-print"></i> Print\n                        </button>\n                    </div>\n\n                    \x3c!-- Close Button --\x3e\n                    <button id="close-qr-btn" style="\n                        background: #800000;\n                        color: white;\n                        border: none;\n                        width: 40px;\n                        height: 40px;\n                        border-radius: 50%;\n                        font-size: 20px;\n                        cursor: pointer;\n                        box-shadow: 0 2px 10px rgba(0,0,0,0.2);\n                        display: flex;\n                        align-items: center;\n                        justify-content: center;\n                    ">×</button>\n                </div>\n\n                \x3c!-- Header --\x3e\n                <div style="text-align: center; margin-bottom: 40px;">\n                    <h1 style="\n                        font-size: 48px;\n                        font-weight: 700;\n                        color: #800000;\n                        margin: 0 0 10px 0;\n                    ">ZCM Track</h1>\n                    <p style="\n                        font-size: 20px;\n                        color: #666;\n                        margin: 0;\n                    ">Teacher Attendance System</p>\n                </div>\n\n                \x3c!-- Class Name --\x3e\n                <div style="\n                    background: linear-gradient(135deg, #800000 0%, #003366 100%);\n                    color: white;\n                    padding: 30px 60px;\n                    border-radius: 16px;\n                    margin-bottom: 50px;\n                    box-shadow: 0 4px 20px rgba(0,0,0,0.15);\n                ">\n                    <h2 style="\n                        font-size: 64px;\n                        font-weight: 700;\n                        margin: 0;\n                        text-align: center;\n                    ">${t.name}</h2>\n                </div>\n\n                \x3c!-- QR Code Container --\x3e\n                <div style="\n                    background: white;\n                    padding: 30px;\n                    border-radius: 20px;\n                    box-shadow: 0 8px 30px rgba(0,0,0,0.1);\n                    border: 4px solid #800000;\n                    margin-bottom: 40px;\n                ">\n                    <div id="qr-poster-display"></div>\n                </div>\n\n                \x3c!-- Instructions --\x3e\n                <div style="\n                    text-align: center;\n                    max-width: 600px;\n                ">\n                    <h3 style="\n                        font-size: 24px;\n                        font-weight: 600;\n                        color: #333;\n                        margin: 0 0 20px 0;\n                    ">How to Check In</h3>\n                    <ol style="\n                        text-align: left;\n                        font-size: 18px;\n                        color: #666;\n                        line-height: 1.8;\n                        padding-left: 20px;\n                    ">\n                        <li>Open the Teacher Check-in page on your mobile device</li>\n                        <li>Scan this QR code with your camera</li>\n                        <li>Enter your Teacher ID</li>\n                        <li>Confirm your attendance</li>\n                    </ol>\n                </div>\n\n                \x3c!-- Footer --\x3e\n                <div style="\n                    position: absolute;\n                    bottom: 30px;\n                    text-align: center;\n                    color: #999;\n                    font-size: 14px;\n                ">\n                    Class ID: ${t.id}\n                </div>\n            </div>\n        `,document.body.appendChild(n);const s=`https://zahiramaw.github.io/Track/teacher/?classroom=${t.id}`;new QRCode(n.querySelector("#qr-poster-display"),{text:s,width:300,height:300}),setTimeout(()=>{const e=document.getElementById("close-qr-btn");e&&e.addEventListener("click",a),n.addEventListener("click",e=>{e.target===n&&a()});const s=e=>{"Escape"===e.key&&(a(),document.removeEventListener("keydown",s))};document.addEventListener("keydown",s);const d=document.getElementById("download-qr-btn");d&&d.addEventListener("click",()=>{const e=n.querySelector("#qr-poster-display canvas");if(e){const n=document.createElement("a");n.download=`QR_${t.name.replace(/\s+/g,"_")}_${t.id}.png`,n.href=e.toDataURL("image/png"),n.click()}})},100)},async downloadQR(e){const t=(await c.get("classrooms")).find(t=>t.id===e);if(!t)return;const n=document.createElement("div");n.style.position="fixed",n.style.top="-9999px",n.style.left="-9999px",n.style.padding="20px",n.style.background="white",n.style.border="4px solid #800000",n.style.borderRadius="12px",n.style.textAlign="center",n.id="temp-poster-container",document.body.appendChild(n);const a=document.createElement("h2");a.textContent=t.name,a.style.fontSize="32px",a.style.fontWeight="700",a.style.marginBottom="20px",n.appendChild(a);const s=document.createElement("div");s.id="qr-poster-display",n.appendChild(s);const d=`https://zahiramaw.github.io/class/teacher/?classroom=${t.id}`;new QRCode(s,{text:d,width:300,height:300,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H}),setTimeout(()=>{html2canvas(n).then(e=>{const a=document.createElement("a");a.download=`Poster_${t.name.replace(/\s+/g,"_")}_${t.id}.png`,a.href=e.toDataURL("image/png"),a.click(),n.remove()}).catch(e=>{n.remove()})},200)},async printQRCodes(){const e=await c.get("classrooms"),t=document.getElementById("print-area");t.innerHTML="",t.classList.remove("hidden"),e.forEach(e=>{const n=document.createElement("div");n.className="qr-print-item",n.innerHTML=`\n                <h3>${e.name}</h3>\n                <div class="qr-code"></div>\n            `,t.appendChild(n);const a=`https://zahiramaw.github.io/class/teacher/?classroom=${e.id}`;new QRCode(n.querySelector(".qr-code"),{text:a,width:150,height:150})}),setTimeout(()=>{window.print(),t.classList.add("hidden")},500)},async markDayOff(e){e.preventDefault();const t=document.getElementById("off-day-date").value,n=document.getElementById("off-day-class").value,a=document.getElementById("off-day-reason").value||"Not specified";if(t)try{if("all"===n){const e={date:t,type:"all",reason:a,createdAt:Date.now()};await c.add("offDays",e),alert(`All classes marked as off for ${t}`)}else{const e=(await c.get("classrooms")).find(e=>e.id===n);if(!e)return void alert("Class not found");const s={date:t,type:"specific",classId:n,className:e.name,reason:a,createdAt:Date.now()};await c.add("offDays",s),alert(`${e.name} marked as off for ${t}`)}document.getElementById("off-day-date").value="",document.getElementById("off-day-class").value="all",document.getElementById("off-day-reason").value="",await this.renderOffDaysList()}catch(e){alert("Error: "+e.message)}else alert("Please select a date")},async markTeacherOff(e){e.preventDefault();const t=document.getElementById("off-teacher-id").value,n=document.getElementById("off-teacher-date").value,a=document.getElementById("off-teacher-reason").value||"Not specified";if(t&&n)try{const e=(await c.get("teachers")).find(e=>e.id===t);if(!e)return void alert("Teacher not found");const s={date:n,teacherId:t,teacherName:e.name,reason:a,createdAt:Date.now()};await c.add("teacherOffDays",s),alert(`${e.name} marked as off for ${n}`),document.getElementById("off-teacher-id").value="",document.getElementById("off-teacher-date").value="",document.getElementById("off-teacher-reason").value="",await this.renderTeacherOffDaysList()}catch(e){alert("Error: "+e.message)}else alert("Please select both teacher and date")},async renderOffDaysList(){const e=document.getElementById("off-days-list");if(e)try{const t=await c.get("offDays");if(t.sort((e,t)=>new Date(t.date)-new Date(e.date)),0===t.length)return void(e.innerHTML='<div class="text-gray-400 text-sm text-center py-4">No off days scheduled</div>');e.innerHTML="",t.forEach(t=>{const n=new Date(t.date).toLocaleDateString("en-US",{weekday:"short",year:"numeric",month:"short",day:"numeric"}),a="all"===t.type?"All Classes":t.className,s=document.createElement("div");s.className="p-3 bg-gray-50 rounded border border-gray-200",s.innerHTML=`\n                    <div class="flex justify-between items-start">\n                        <div class="flex-1">\n                            <div class="font-semibold text-sm">${n}</div>\n                            <div class="text-xs text-gray-600 mt-1">\n                                <i class="fas fa-school"></i> ${a}\n                            </div>\n                            <div class="text-xs text-gray-500 mt-1">\n                                <i class="fas fa-info-circle"></i> ${t.reason}\n                            </div>\n                        </div>\n                        <button onclick="app.deleteOffDay('${t.id}')" \n                                class="text-red-600 hover:text-red-800 ml-2" \n                                title="Delete">\n                            <i class="fas fa-trash"></i>\n                        </button>\n                    </div>\n                `,e.appendChild(s)})}catch(t){e.innerHTML='<div class="text-red-500 text-sm">Error loading off days</div>'}},async renderTeacherOffDaysList(){const e=document.getElementById("teacher-off-days-list");if(e)try{const t=await c.get("teacherOffDays");if(t.sort((e,t)=>new Date(t.date)-new Date(e.date)),0===t.length)return void(e.innerHTML='<div class="text-gray-400 text-sm text-center py-4">No teacher off days scheduled</div>');e.innerHTML="",t.forEach(t=>{const n=new Date(t.date).toLocaleDateString("en-US",{weekday:"short",year:"numeric",month:"short",day:"numeric"}),a=document.createElement("div");a.className="p-3 bg-gray-50 rounded border border-gray-200",a.innerHTML=`\n                    <div class="flex justify-between items-start">\n                        <div class="flex-1">\n                            <div class="font-semibold text-sm">${n}</div>\n                            <div class="text-xs text-gray-600 mt-1">\n                                <i class="fas fa-user"></i> ${t.teacherName} (ID: ${t.teacherId})\n                            </div>\n                            <div class="text-xs text-gray-500 mt-1">\n                                <i class="fas fa-info-circle"></i> ${t.reason}\n                            </div>\n                        </div>\n                        <button onclick="app.deleteTeacherOffDay('${t.id}')" \n                                class="text-red-600 hover:text-red-800 ml-2" \n                                title="Delete">\n                            <i class="fas fa-trash"></i>\n                        </button>\n                    </div>\n                `,e.appendChild(a)})}catch(t){e.innerHTML='<div class="text-red-500 text-sm">Error loading teacher off days</div>'}},async deleteOffDay(e){if(confirm("Are you sure you want to delete this off day record?"))try{await c.delete("offDays",e),await this.renderOffDaysList()}catch(e){alert("Error: "+e.message)}},async deleteTeacherOffDay(e){if(confirm("Are you sure you want to delete this teacher off day record?"))try{await c.delete("teacherOffDays",e),await this.renderTeacherOffDaysList()}catch(e){alert("Error: "+e.message)}}};window.app=l,document.addEventListener("DOMContentLoaded",()=>{l.init()});