import{db as e,collection as t,getDocs as a,addDoc as n,query as s,where as r,doc as o,setDoc as d,deleteDoc as i}from"./firebase-init.js";const c={cache:{teachers:null,classrooms:null,attendance:null},async getAttendanceByDate(n){try{const o=s(t(e,"attendance"),r("date","==",n)),d=await a(o),i=[];return d.forEach(e=>{i.push({id:e.id,...e.data()})}),i}catch(e){return[]}},async getAttendanceByRange(n,o){try{const d=s(t(e,"attendance"),r("date",">=",n),r("date","<=",o)),i=await a(d),c=[];return i.forEach(e=>{c.push({id:e.id,...e.data()})}),c}catch(e){return[]}},async getOffDaysByDate(n){try{const o=s(t(e,"offDays"),r("date","==",n)),d=await a(o),i=[];return d.forEach(e=>{i.push({id:e.id,...e.data()})}),i}catch(e){return[]}},async getTeacherOffDaysByDate(n){try{const o=s(t(e,"teacherOffDays"),r("date","==",n)),d=await a(o),i=[];return d.forEach(e=>{i.push({id:e.id,...e.data()})}),i}catch(e){return[]}},async get(n){if("attendance"!==n&&this.cache[n])return this.cache[n];try{const s=await a(t(e,n)),r=[];return s.forEach(e=>{const t=e.data();r.push({id:e.id,...t})}),"teachers"===n&&r.length,this.cache[n]=r,r}catch(e){return[]}},async add(a,s){try{let r;return s.id&&"attendance"!==a?(await d(o(e,a,String(s.id)),s),r={id:String(s.id)}):r=await n(t(e,a),s),this.cache[a]=null,r.id}catch(e){throw e}},async delete(t,a){try{await i(o(e,t,String(a))),this.cache[t]=null}catch(e){throw e}},async seedIfEmpty(){if(0===(await this.get("teachers")).length){const e=l.getTodayDate(),t=[{id:"101",name:"John Smith",subject:"Mathematics",dateAdded:e,createdAt:(new Date).toISOString()},{id:"102",name:"Sarah Johnson",subject:"Science",dateAdded:e,createdAt:(new Date).toISOString()}];for(const e of t)await this.add("teachers",e);const a=[{id:"C001",name:"Grade 10A",subject:"General"},{id:"C002",name:"Grade 10B",subject:"General"}];for(const e of a)await this.add("classrooms",e)}}},l={chart:null,getTodayDate(){const e=new Date;return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`},async init(){sessionStorage.getItem("isLoggedIn")?this.navigateTo("dashboard"):this.navigateTo("login");const e=this.getTodayDate(),t=document.getElementById("stats-date");t&&!t.value&&(t.value=e);const a=document.getElementById("matrix-date");a&&!a.value&&(a.value=e),await this.populateTeacherSelect(),await c.get("classrooms"),c.seedIfEmpty()},formatTeacherName(e){if(!e)return"";const t=e.trim().split(/\s+/),a=[],n=[];return t.forEach(e=>{e.includes(".")||1===e.length?a.push(e):n.push(e)}),n.length>0?`${n.join(" ")} ${a.join(" ")}`.trim():e},async populateTeacherSelect(){const e=document.getElementById("stats-teacher-select");if(!e||e.options.length>1)return;const t=await c.get("teachers");t.sort((e,t)=>(parseInt(e.id.replace(/\D/g,""))||0)-(parseInt(t.id.replace(/\D/g,""))||0)),t.forEach(t=>{const a=document.createElement("option");a.value=t.id,a.textContent=`${t.id} - ${this.formatTeacherName(t.name)}`,e.appendChild(a)})},navigateTo(e){document.querySelectorAll(".view").forEach(e=>e.classList.add("hidden"));const t=document.getElementById(`view-${e}`);t&&t.classList.remove("hidden"),"dashboard"===e&&this.renderDashboard()},authorizedEmails:["raashid.mm@gmail.com","raashidmansoor@gmail.com","relaugh@gmail.com","safwanmoha@gmail.com","uzmannazlin76@gmail.com"],handleGoogleLogin(e){if(e.credential){const t=JSON.parse(atob(e.credential.split(".")[1])).email;if(!this.authorizedEmails.includes(t))return void alert(`Access Denied!\n\nYour email (${t}) is not authorized to access this system.\n\nPlease contact the administrator.`);sessionStorage.setItem("isLoggedIn","true"),sessionStorage.setItem("userEmail",t),this.navigateTo("dashboard")}},logout(){sessionStorage.removeItem("isLoggedIn"),sessionStorage.removeItem("userEmail"),this.navigateTo("login")},switchTab(e){document.querySelectorAll(".tab-content").forEach(e=>e.classList.add("hidden")),document.querySelectorAll(".nav-link").forEach(e=>e.classList.remove("active")),document.getElementById(`content-${e}`).classList.remove("hidden"),document.getElementById(`tab-${e}`).classList.add("active"),"overview"!==e&&"dashboard"!==e||this.renderOverview(),"class"===e&&this.renderMatrix(),"teachers"===e&&this.renderTeacherStats(),"admin"===e&&this.renderAdmin()},async renderTeacherStats(){const e=document.getElementById("stats-date");e.value||(e.value=this.getTodayDate());const t=e.value,a=document.getElementById("stats-teacher-select");await this.populateTeacherSelect(),!a.value&&a.options.length>1&&(a.selectedIndex=1);const n=a.value;if(!n)return;const s=await c.getAttendanceByDate(t),r=document.querySelector("#stats-daily-table tbody");r.innerHTML="";Schedule.getPeriods(new Date(t)).filter(e=>"break"!==e.type).forEach(e=>{const t=s.find(t=>t.teacherId===n&&String(t.period)===String(e.id));let a="-",o="-",d="-";if(t){const n=new Date(t.timestamp);a=n.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),d=t.className||"-";const s=Schedule.calculateStatus(e,n).delayMins;o=s<=5?'<span class="font-bold text-green-600">On time</span>':s<=15?`<span class="font-bold text-yellow-600">${s} minutes</span>`:`<span class="font-bold text-red-600">${s} minutes</span>`}r.innerHTML+=`\n                <tr>\n                    <td class="font-medium">${e.name}</td>\n                    <td>${d}</td>\n                    <td class="font-bold">${a}</td>\n                    <td>${o}</td>\n                </tr>\n            `});const o=new Date;let d=new Date;d.setDate(1);const i=d.toLocaleDateString("en-CA"),l=o.toLocaleDateString("en-CA"),m=(await c.getAttendanceByRange(i,l)).filter(e=>e.teacherId===n);let h=0,u=0,f=0;m.forEach(e=>{const t=new Date(e.timestamp),a=Schedule.getPeriods(t).find(t=>String(t.id)===String(e.period));if(a&&"break"!==a.type){const e=Schedule.calculateStatus(a,t).delayMins;e<=5?h++:e<=15?u++:f++}}),document.getElementById("summary-on-time").textContent=h,document.getElementById("summary-late-10").textContent=u,document.getElementById("summary-late-20").textContent=f},async renderMatrix(){const e=document.getElementById("matrix-grade").value,t=document.getElementById("matrix-date").value||this.getTodayDate();document.getElementById("matrix-date").value=t;const a=await c.get("classrooms"),n=await c.getAttendanceByDate(t),s=a.filter(t=>!e||t.name.includes(`Grade ${e}`));s.sort((e,t)=>e.name.localeCompare(t.name,void 0,{numeric:!0,sensitivity:"base"}));const r=document.querySelector("#matrix-table tbody"),o=document.querySelector("#matrix-table thead tr"),d=Schedule.getPeriods(new Date(t)).filter(e=>"break"!==e.type);let i="<th>Class</th>";d.forEach(e=>{i+=`<th>P${e.id}</th>`}),o.innerHTML=i,r.innerHTML="",s.forEach(e=>{let t=`<tr><td class="font-bold">${e.name}</td>`;d.forEach(a=>{const s=n.find(t=>t.className===e.name&&String(t.period)===String(a.id));if(s){const e=new Date(s.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),a="Late"===s.status?"text-red-600":"text-green-600";t+=`\n                        <td class="text-xs">\n                            <div class="font-bold">${s.teacherName}</div>\n                            <div class="${a}">${e}</div>\n                        </td>\n                    `}else t+="<td></td>"}),t+="</tr>",r.innerHTML+=t})},renderDashboard(){this.renderOverview(),this.dashboardInterval&&clearInterval(this.dashboardInterval),this.dashboardInterval=setInterval(()=>{document.getElementById("content-overview")&&!document.getElementById("content-overview").classList.contains("hidden")&&this.renderOverview()},3e4)},async renderOverview(){const e=await c.get("teachers"),t=await c.get("classrooms"),a=this.getTodayDate(),n=await c.getAttendanceByDate(a),s=document.getElementById("dashboard-filter")?document.getElementById("dashboard-filter").value:"today";let r=[];if("today"===s)r=n;else{const e=new Date;let t=new Date;"weekly"===s?t.setDate(e.getDate()-7):t.setDate(1);const a=t.toLocaleDateString("en-CA"),n=e.toLocaleDateString("en-CA");r=await c.getAttendanceByRange(a,n)}const o=new Set(r.map(e=>e.teacherId)),d=r.filter(e=>"On Time"===e.status).length,i=r.filter(e=>"Late"===e.status).length;let l=0;if("today"===s){const e=new Date,a=Schedule.getPeriods(e).filter(e=>"break"!==e.type).filter(t=>{const[a,n]=t.end.split(":").map(Number),s=new Date(e);return s.setHours(a,n,0,0),e>s});for(const e of a){const a=new Set(n.filter(t=>String(t.period)===String(e.id)).map(e=>e.className));l+=t.length-a.size}}else l=Math.max(0,e.length-o.size);document.getElementById("stat-on-time").textContent=d,document.getElementById("stat-late").textContent=i,document.getElementById("stat-absent").textContent=l;const m=Schedule.getCurrentPeriod(),h=document.getElementById("current-period-badge"),u=document.getElementById("unattended-list");if(u.innerHTML="",m&&"break"!==m.type){h.textContent=m.name,h.className="px-2 py-1 bg-green-100 text-green-800 rounded text-xs font-bold";const e=new Set(n.filter(e=>String(e.period)===String(m.id)).map(e=>e.className)),a=t.filter(t=>!e.has(t.name)).sort((e,t)=>e.name.localeCompare(t.name,void 0,{numeric:!0,sensitivity:"base"}));0===a.length?u.innerHTML='<div class="text-green-600 text-sm col-span-full text-center py-4 font-bold">\n                    <i class="fas fa-check-circle"></i> All classes attended!\n                </div>':a.forEach(e=>{const t=document.createElement("div");t.className="p-2 bg-red-50 border border-red-100 rounded text-center text-red-700 font-bold text-sm",t.textContent=e.name,u.appendChild(t)})}else h.textContent=m?m.name:"After Hours",h.className="px-2 py-1 bg-gray-200 rounded text-xs font-bold text-gray-600",u.innerHTML=`<div class="text-gray-500 text-sm col-span-full text-center py-4">\n                ${m?"Currently in Break/Interval":"School is closed"}\n            </div>`;const f=document.getElementById("recent-activity-list");f.innerHTML="";const g=[...n].sort((e,t)=>t.timestamp-e.timestamp).slice(0,5);0===g.length?f.innerHTML='<div class="text-gray-400 text-sm text-center">No activity today</div>':g.forEach(e=>{const t=new Date(e.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});f.innerHTML+=`\n                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">\n                        <div>\n                            <div class="font-bold text-sm">${e.teacherName}</div>\n                            <div class="text-xs text-gray-500">${e.className} ‚Ä¢ ${e.subject}</div>\n                        </div>\n                        <div class="text-right">\n                            <div class="font-bold text-sm">${t}</div>\n                            <div class="text-xs ${"Late"===e.status?"text-red-600":"text-green-600"}">${e.status}</div>\n                        </div>\n                    </div>\n                `})},async renderAdmin(){c.cache.teachers=null,c.cache.classrooms=null;const e=await c.get("teachers"),t=document.querySelector("#teachers-table tbody");if(!t)return;t.innerHTML="",0===e.length?t.innerHTML='<tr><td colspan="4" class="text-center text-gray-500 py-4">No teachers found. Add teachers using the import script or manually.</td></tr>':(e.sort((e,t)=>(parseInt(e.id.replace(/\D/g,""))||0)-(parseInt(t.id.replace(/\D/g,""))||0)),e.forEach(e=>{const a=e.name||e.teacherName||`Teacher ${e.id}`||"-";t.innerHTML+=`\n                    <tr>\n                        <td>${e.id||"-"}</td>\n                        <td>${a}</td>\n                        <td>${e.subject||"General"}</td>\n                        <td>\n                            <button onclick="app.editTeacher('${e.id}')" class="text-blue-600 hover:text-blue-800 text-lg" title="Edit Teacher" style="padding: 0.25rem 0.5rem;">\n                                <i class="fas fa-edit"></i>\n                            </button>\n                        </td>\n                    </tr>\n                `}));const a=await c.get("classrooms"),n=document.querySelector("#classrooms-table tbody");if(!n)return;n.innerHTML="",0===a.length?n.innerHTML='<tr><td colspan="3" class="text-center text-gray-500 py-4">No classrooms found. Add classrooms using the Add Classroom button.</td></tr>':(a.sort((e,t)=>e.name.localeCompare(t.name,void 0,{numeric:!0,sensitivity:"base"})),a.forEach(e=>{n.innerHTML+=`\n                <tr>\n                    <td class="font-bold">${e.name}</td>\n                    <td>\n                        <div class="flex items-center gap-2">\n                            <button onclick="app.showQR('${e.id}')" class="btn-qr-view" title="View QR Code">\n                                <i class="fas fa-qrcode"></i> View\n                            </button>\n                            <button onclick="app.downloadQR('${e.id}')" class="btn-qr-download" title="Download QR Code">\n                                <i class="fas fa-download"></i> Download\n                            </button>\n                        </div>\n                    </td>\n                    <td>\n                        <div class="flex items-center gap-2">\n                            <button onclick="app.editClassroom('${e.id}')" class="text-blue-600 hover:text-blue-800 text-lg" title="Edit Classroom" style="padding: 0.25rem 0.5rem;">\n                                <i class="fas fa-edit"></i>\n                            </button>\n                            <button onclick="app.deleteClassroom('${e.id}')" class="text-red-600 hover:text-red-800 text-lg" title="Delete Classroom" style="padding: 0.25rem 0.5rem;">\n                                <i class="fas fa-trash"></i>\n                            </button>\n                        </div>\n                    </td>\n                </tr>\n            `}));const s=document.getElementById("off-day-class");if(s){const e=Array.from(s.options).map(e=>e.value);a.forEach(t=>{if(!e.includes(t.id)){const e=document.createElement("option");e.value=t.id,e.textContent=t.name,s.appendChild(e)}})}const r=document.getElementById("off-teacher-id");r&&(r.innerHTML='<option value="" disabled selected>Select a Teacher</option>',e.forEach(e=>{const t=document.createElement("option");t.value=e.id,t.textContent=`${e.id} - ${this.formatTeacherName(e.name)}`,r.appendChild(t)})),await this.renderOffDaysList(),await this.renderTeacherOffDaysList()},openModal(e){document.getElementById("modal-overlay").classList.add("open");const t=document.getElementById("modal-fields");t.dataset.type=e,t.dataset.mode="add",t.dataset.teacherId="",t.dataset.classroomId="",document.getElementById("modal-title").textContent="teacher"===e?"Add Teacher":"Add Classroom","teacher"===e?t.innerHTML='\n                <input type="number" name="id" class="input" placeholder="Teacher ID (e.g. 101)" required inputmode="numeric">\n                <input type="text" name="name" class="input" placeholder="Full Name" required>\n                <input type="text" name="subject" class="input" placeholder="Subject" required>\n            ':"classroom"===e&&(t.innerHTML='\n                <input type="text" name="id" class="input" placeholder="Class ID (e.g. G6A)" required>\n                <input type="text" name="name" class="input" placeholder="Class Name (e.g. Grade 6A)" required>\n            ')},openTeacherModal(){this.openModal("teacher")},openClassroomModal(){this.openModal("classroom")},async editClassroom(e){try{const t=(await c.get("classrooms")).find(t=>t.id===e);if(!t)return void alert("Classroom not found");document.getElementById("modal-overlay").classList.add("open");const a=document.getElementById("modal-fields");a.dataset.type="classroom",a.dataset.mode="edit",a.dataset.classroomId=e,document.getElementById("modal-title").textContent="Edit Classroom",a.innerHTML=`\n                <input type="text" name="id" class="input" value="${t.id||""}" placeholder="Class ID (e.g. G6A)" required ${t.id?"readonly":""}>\n                <input type="text" name="name" class="input" value="${t.name||""}" placeholder="Class Name (e.g. Grade 6A)" required>\n            `}catch(e){alert("Error loading classroom data")}},async deleteClassroom(e){if(confirm("Are you sure you want to delete this classroom? This action cannot be undone."))try{await c.delete("classrooms",e),c.cache.classrooms=null,await this.renderAdmin()}catch(e){alert("Error deleting classroom: "+e.message)}},async editTeacher(e){try{const t=(await c.get("teachers")).find(t=>t.id===e);if(!t)return void alert("Teacher not found");document.getElementById("modal-overlay").classList.add("open");const a=document.getElementById("modal-fields");a.dataset.type="teacher",a.dataset.mode="edit",a.dataset.teacherId=e,document.getElementById("modal-title").textContent="Edit Teacher",a.innerHTML=`\n                <input type="number" name="id" class="input" value="${t.id||""}" placeholder="Teacher ID (e.g. 101)" required inputmode="numeric" ${t.id?"readonly":""}>\n                <input type="text" name="name" class="input" value="${t.name||""}" placeholder="Full Name" required>\n                <input type="text" name="subject" class="input" value="${t.subject||"General"}" placeholder="Subject" required>\n            `}catch(e){alert("Error loading teacher data")}},closeModal(){document.getElementById("modal-overlay").classList.remove("open")},async handleModalSubmit(t){t.preventDefault();const a=document.getElementById("modal-fields"),n=a.dataset.type,s=a.dataset.mode||"add",r=a.querySelectorAll("input"),i={};r.forEach(e=>i[e.name]=e.value);const l="teacher"===n?"teachers":"classrooms";try{if("teacher"===n)if("edit"===s){const t=a.dataset.teacherId,n={id:t,name:i.name,subject:i.subject||"General"},s=(await c.get("teachers")).find(e=>e.id===t);s?(n.dateAdded=s.dateAdded,n.createdAt=s.createdAt):(n.dateAdded=this.getTodayDate(),n.createdAt=(new Date).toISOString()),await d(o(e,"teachers",t),n),c.cache.teachers=null}else i.createdAt=(new Date).toISOString(),i.dateAdded=this.getTodayDate(),await c.add(l,i);else await c.add(l,i);this.closeModal(),await this.renderAdmin()}catch(e){alert("Error saving data: "+e.message)}},async deleteItem(e,t){if(confirm("Are you sure?"))try{await c.delete(e,t),this.renderAdmin()}catch(e){alert("Error deleting: "+e.message)}},resetSystem(){confirm("DANGER: This will wipe all local data (not cloud). Continue?")&&(localStorage.clear(),location.reload())},async populateClasses(){if(!confirm("This will add/update all classes from Grade 6 to 11 (Sections A, B, C, D, E1, E2). Continue?"))return;const t=[6,7,8,9,10,11],a=["A","B","C","D","E1","E2"];let n=0,s=0;try{const r=await c.get("classrooms"),i=new Set(r.map(e=>e.id));for(const r of t)for(const t of a){const a=`Grade ${r}${t}`,c=`G${r}${t}`,l={id:c,name:a,subject:"General"};await d(o(e,"classrooms",c),l),i.has(c)?s++:n++}c.cache.classrooms=null,alert(`Successfully processed ${n+s} classes!\n- New: ${n}\n- Updated: ${s}\n\nGrades 6-11, Sections: A, B, C, D, E1, E2`),this.renderAdmin()}catch(e){alert("Error populating classes: "+e.message)}},async cleanupAndResetDatabase(){if(confirm("‚ö†Ô∏è This will DELETE ALL existing data and create fresh records with new 3-digit teacher IDs. This cannot be undone. Continue?"))try{const n=await a(t(e,"teachers"));let s=0;for(const t of n.docs)await i(o(e,"teachers",t.id)),s++;const r=await a(t(e,"classrooms"));s=0;for(const t of r.docs)await i(o(e,"classrooms",t.id)),s++;const c=await a(t(e,"attendance"));s=0;for(const t of c.docs)await i(o(e,"attendance",t.id)),s++;const l=this.getTodayDate(),m=(new Date).toISOString(),h=[{id:"101",name:"Mr. Ahmed",subject:"Mathematics",dateAdded:l,createdAt:m},{id:"102",name:"Ms. Fatima",subject:"Science",dateAdded:l,createdAt:m},{id:"103",name:"Mr. Rizwan",subject:"English",dateAdded:l,createdAt:m},{id:"104",name:"Ms. Ayesha",subject:"History",dateAdded:l,createdAt:m},{id:"105",name:"Mr. Zaid",subject:"Geography",dateAdded:l,createdAt:m}];for(const t of h)await d(o(e,"teachers",t.id),t);const u=[6,7,8,9,10,11],f=["A","B"];let g=0;for(const t of u)for(const a of f){const n={id:`G${t}${a}`,name:`Grade ${t}${a}`,subject:"General"};await d(o(e,"classrooms",n.id),n),g++}alert(`‚úÖ Database cleaned up successfully!\n\nCreated:\n- ${h.length} teachers (IDs: 101-105)\n- ${g} classrooms\n\nPlease refresh the page.`),this.renderAdmin()}catch(e){alert(`Error: ${e.message}\n\nCheck the console for details.`)}},async generateSampleData(){if(confirm("This will generate comprehensive sample data (Teachers, Classes, Attendance) for the last 7 days. Continue?"))try{const t=this.getTodayDate(),a=(new Date).toISOString(),n=[{id:"101",name:"Mr. Ahmed",subject:"Mathematics",dateAdded:t,createdAt:a},{id:"102",name:"Ms. Fatima",subject:"Science",dateAdded:t,createdAt:a},{id:"103",name:"Mr. Rizwan",subject:"English",dateAdded:t,createdAt:a},{id:"104",name:"Ms. Ayesha",subject:"History",dateAdded:t,createdAt:a},{id:"105",name:"Mr. Zaid",subject:"Geography",dateAdded:t,createdAt:a}];for(const t of n)await d(o(e,"teachers",t.id),t);let s=await c.get("classrooms");if(s.length<5){const t=[{id:"C_TEST_01",name:"Grade 10A"},{id:"C_TEST_02",name:"Grade 10B"},{id:"C_TEST_03",name:"Grade 11A"},{id:"C_TEST_04",name:"Grade 9C"}];for(const a of t)await d(o(e,"classrooms",a.id),a);s=[...s,...t]}const r=new Date;let i=0;for(let e=0;e<7;e++){const t=new Date(r);t.setDate(t.getDate()-e);const a=t.toLocaleDateString("en-CA");if(0===t.getDay()||6===t.getDay())continue;const o=Schedule.getPeriods(t).filter(e=>"break"!==e.type);for(const e of n)for(const n of o){if(Math.random()<.15)continue;const r=s[Math.floor(Math.random()*s.length)],o=Math.random();let d=0,l="On Time";o<.7?d=Math.floor(5*Math.random()):o<.9?(d=6+Math.floor(10*Math.random()),l="Late"):(d=16+Math.floor(15*Math.random()),l="Late");const[m,h]=n.start.split(":").map(Number),u=new Date(t);u.setHours(m,h+d,0);const f={id:Date.now()+Math.random(),teacherId:e.id,teacherName:e.name,className:r.name,subject:e.subject,period:n.id,timestamp:u.getTime(),date:a,status:l};await c.add("attendance",f),i++}}alert(`Generated ${i} attendance records for the last week!`),location.reload()}catch(e){alert("Error generating data: "+e.message)}},async showQR(e){const t=(await c.get("classrooms")).find(t=>t.id===e);if(!t)return;const a=document.createElement("div");a.id="qr-overlay",a.style.cssText="\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: rgba(0,0,0,0.9);\n            z-index: 10000;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            padding: 20px;\n        ";const n=()=>{const e=document.getElementById("qr-overlay");e&&e.remove()};a.innerHTML=`\n            <div id="qr-poster-content" style="\n                background: white;\n                width: 210mm;\n                height: 297mm;\n                padding: 40px;\n                box-shadow: 0 10px 50px rgba(0,0,0,0.5);\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                justify-content: center;\n                position: relative;\n                font-family: 'Inter', sans-serif;\n            ">\n                \x3c!-- Action Buttons Container --\x3e\n                <div style="\n                    position: absolute;\n                    top: 20px;\n                    left: 20px;\n                    right: 20px;\n                    display: flex;\n                    justify-content: space-between;\n                    align-items: center;\n                ">\n                    \x3c!-- Left buttons --\x3e\n                    <div style="display: flex; gap: 10px;">\n                        <button id="download-qr-btn" style="\n                            background: #059669;\n                            color: white;\n                            border: none;\n                            padding: 10px 20px;\n                            border-radius: 8px;\n                            font-size: 14px;\n                            cursor: pointer;\n                            box-shadow: 0 2px 10px rgba(0,0,0,0.2);\n                            display: flex;\n                            align-items: center;\n                            gap: 8px;\n                        ">\n                            <i class="fas fa-download"></i> Download QR\n                        </button>\n                        <button onclick="window.print()" style="\n                            background: #003366;\n                            color: white;\n                            border: none;\n                            padding: 10px 20px;\n                            border-radius: 8px;\n                            font-size: 14px;\n                            cursor: pointer;\n                            box-shadow: 0 2px 10px rgba(0,0,0,0.2);\n                            display: flex;\n                            align-items: center;\n                            gap: 8px;\n                        ">\n                            <i class="fas fa-print"></i> Print\n                        </button>\n                    </div>\n\n                    \x3c!-- Close Button --\x3e\n                    <button id="close-qr-btn" style="\n                        background: #800000;\n                        color: white;\n                        border: none;\n                        width: 40px;\n                        height: 40px;\n                        border-radius: 50%;\n                        font-size: 20px;\n                        cursor: pointer;\n                        box-shadow: 0 2px 10px rgba(0,0,0,0.2);\n                        display: flex;\n                        align-items: center;\n                        justify-content: center;\n                    ">√ó</button>\n                </div>\n\n                \x3c!-- Header --\x3e\n                <div style="text-align: center; margin-bottom: 40px;">\n                    <h1 style="\n                        font-size: 48px;\n                        font-weight: 700;\n                        color: #800000;\n                        margin: 0 0 10px 0;\n                    ">ZCM Track</h1>\n                    <p style="\n                        font-size: 20px;\n                        color: #666;\n                        margin: 0;\n                    ">Teacher Attendance System</p>\n                </div>\n\n                \x3c!-- Class Name --\x3e\n                <div style="\n                    background: linear-gradient(135deg, #800000 0%, #003366 100%);\n                    color: white;\n                    padding: 30px 60px;\n                    border-radius: 16px;\n                    margin-bottom: 50px;\n                    box-shadow: 0 4px 20px rgba(0,0,0,0.15);\n                ">\n                    <h2 style="\n                        font-size: 64px;\n                        font-weight: 700;\n                        margin: 0;\n                        text-align: center;\n                    ">${t.name}</h2>\n                </div>\n\n                \x3c!-- QR Code Container --\x3e\n                <div style="\n                    background: white;\n                    padding: 30px;\n                    border-radius: 20px;\n                    box-shadow: 0 8px 30px rgba(0,0,0,0.1);\n                    border: 4px solid #800000;\n                    margin-bottom: 40px;\n                ">\n                    <div id="qr-poster-display"></div>\n                </div>\n\n                \x3c!-- Instructions --\x3e\n                <div style="\n                    text-align: center;\n                    max-width: 600px;\n                ">\n                    <h3 style="\n                        font-size: 24px;\n                        font-weight: 600;\n                        color: #333;\n                        margin: 0 0 20px 0;\n                    ">How to Check In</h3>\n                    <ol style="\n                        text-align: left;\n                        font-size: 18px;\n                        color: #666;\n                        line-height: 1.8;\n                        padding-left: 20px;\n                    ">\n                        <li>Open the Teacher Check-in page on your mobile device</li>\n                        <li>Scan this QR code with your camera</li>\n                        <li>Enter your Teacher ID</li>\n                        <li>Confirm your attendance</li>\n                    </ol>\n                </div>\n\n                \x3c!-- Footer --\x3e\n                <div style="\n                    position: absolute;\n                    bottom: 30px;\n                    text-align: center;\n                    color: #999;\n                    font-size: 14px;\n                ">\n                    Class ID: ${t.id}\n                </div>\n            </div>\n        `,document.body.appendChild(a);const s=`https://zahiramaw.github.io/Track/teacher/?classroom=${t.id}`;new QRCode(a.querySelector("#qr-poster-display"),{text:s,width:300,height:300}),setTimeout(()=>{const e=document.getElementById("close-qr-btn");e&&e.addEventListener("click",n),a.addEventListener("click",e=>{e.target===a&&n()});const s=e=>{"Escape"===e.key&&(n(),document.removeEventListener("keydown",s))};document.addEventListener("keydown",s);const r=document.getElementById("download-qr-btn");r&&r.addEventListener("click",()=>{const e=a.querySelector("#qr-poster-display canvas");if(e){const a=document.createElement("a");a.download=`QR_${t.name.replace(/\s+/g,"_")}_${t.id}.png`,a.href=e.toDataURL("image/png"),a.click()}})},100)},async downloadQR(e){const t=(await c.get("classrooms")).find(t=>t.id===e);if(!t)return;const a=document.createElement("div");a.style.position="fixed",a.style.top="-9999px",a.style.left="-9999px",a.style.padding="20px",a.style.background="white",a.style.border="4px solid #800000",a.style.borderRadius="12px",a.style.textAlign="center",a.id="temp-poster-container",document.body.appendChild(a);const n=document.createElement("h2");n.textContent=t.name,n.style.fontSize="32px",n.style.fontWeight="700",n.style.marginBottom="20px",a.appendChild(n);const s=document.createElement("div");s.id="qr-poster-display",a.appendChild(s);const r=`https://zahiramaw.github.io/class/teacher/?classroom=${t.id}`;new QRCode(s,{text:r,width:300,height:300,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H}),setTimeout(()=>{html2canvas(a).then(e=>{const n=document.createElement("a");n.download=`Poster_${t.name.replace(/\s+/g,"_")}_${t.id}.png`,n.href=e.toDataURL("image/png"),n.click(),a.remove()}).catch(e=>{a.remove()})},200)},async printQRCodes(){const e=await c.get("classrooms"),t=document.getElementById("print-area");t.innerHTML="",t.classList.remove("hidden"),e.forEach(e=>{const a=document.createElement("div");a.className="qr-print-item",a.innerHTML=`\n                <h3>${e.name}</h3>\n                <div class="qr-code"></div>\n            `,t.appendChild(a);const n=`https://zahiramaw.github.io/class/teacher/?classroom=${e.id}`;new QRCode(a.querySelector(".qr-code"),{text:n,width:150,height:150})}),setTimeout(()=>{window.print(),t.classList.add("hidden")},500)},async markDayOff(e){e.preventDefault();const t=document.getElementById("off-day-date").value,a=document.getElementById("off-day-class").value,n=document.getElementById("off-day-reason").value||"Not specified";if(t)try{if("all"===a){const e={date:t,type:"all",reason:n,createdAt:Date.now()};await c.add("offDays",e),alert(`All classes marked as off for ${t}`)}else{const e=(await c.get("classrooms")).find(e=>e.id===a);if(!e)return void alert("Class not found");const s={date:t,type:"specific",classId:a,className:e.name,reason:n,createdAt:Date.now()};await c.add("offDays",s),alert(`${e.name} marked as off for ${t}`)}document.getElementById("off-day-date").value="",document.getElementById("off-day-class").value="all",document.getElementById("off-day-reason").value="",await this.renderOffDaysList()}catch(e){alert("Error: "+e.message)}else alert("Please select a date")},async markTeacherOff(e){e.preventDefault();const t=document.getElementById("off-teacher-id").value,a=document.getElementById("off-teacher-date").value,n=document.getElementById("off-teacher-reason").value||"Not specified";if(t&&a)try{const e=(await c.get("teachers")).find(e=>e.id===t);if(!e)return void alert("Teacher not found");const s={date:a,teacherId:t,teacherName:e.name,reason:n,createdAt:Date.now()};await c.add("teacherOffDays",s),alert(`${e.name} marked as off for ${a}`),document.getElementById("off-teacher-id").value="",document.getElementById("off-teacher-date").value="",document.getElementById("off-teacher-reason").value="",await this.renderTeacherOffDaysList()}catch(e){alert("Error: "+e.message)}else alert("Please select both teacher and date")},async renderOffDaysList(){const e=document.getElementById("off-days-list");if(e)try{const t=await c.get("offDays");if(t.sort((e,t)=>new Date(t.date)-new Date(e.date)),0===t.length)return void(e.innerHTML='<div class="text-gray-400 text-sm text-center py-4">No off days scheduled</div>');e.innerHTML="",t.forEach(t=>{const a=new Date(t.date).toLocaleDateString("en-US",{weekday:"short",year:"numeric",month:"short",day:"numeric"}),n="all"===t.type?"All Classes":t.className,s=document.createElement("div");s.className="p-3 bg-gray-50 rounded border border-gray-200",s.innerHTML=`\n                    <div class="flex justify-between items-start">\n                        <div class="flex-1">\n                            <div class="font-semibold text-sm">${a}</div>\n                            <div class="text-xs text-gray-600 mt-1">\n                                <i class="fas fa-school"></i> ${n}\n                            </div>\n                            <div class="text-xs text-gray-500 mt-1">\n                                <i class="fas fa-info-circle"></i> ${t.reason}\n                            </div>\n                        </div>\n                        <button onclick="app.deleteOffDay('${t.id}')" \n                                class="text-red-600 hover:text-red-800 ml-2" \n                                title="Delete">\n                            <i class="fas fa-trash"></i>\n                        </button>\n                    </div>\n                `,e.appendChild(s)})}catch(t){e.innerHTML='<div class="text-red-500 text-sm">Error loading off days</div>'}},async renderTeacherOffDaysList(){const e=document.getElementById("teacher-off-days-list");if(e)try{const t=await c.get("teacherOffDays");if(t.sort((e,t)=>new Date(t.date)-new Date(e.date)),0===t.length)return void(e.innerHTML='<div class="text-gray-400 text-sm text-center py-4">No teacher off days scheduled</div>');e.innerHTML="",t.forEach(t=>{const a=new Date(t.date).toLocaleDateString("en-US",{weekday:"short",year:"numeric",month:"short",day:"numeric"}),n=document.createElement("div");n.className="p-3 bg-gray-50 rounded border border-gray-200",n.innerHTML=`\n                    <div class="flex justify-between items-start">\n                        <div class="flex-1">\n                            <div class="font-semibold text-sm">${a}</div>\n                            <div class="text-xs text-gray-600 mt-1">\n                                <i class="fas fa-user"></i> ${t.teacherName} (ID: ${t.teacherId})\n                            </div>\n                            <div class="text-xs text-gray-500 mt-1">\n                                <i class="fas fa-info-circle"></i> ${t.reason}\n                            </div>\n                        </div>\n                        <button onclick="app.deleteTeacherOffDay('${t.id}')" \n                                class="text-red-600 hover:text-red-800 ml-2" \n                                title="Delete">\n                            <i class="fas fa-trash"></i>\n                        </button>\n                    </div>\n                `,e.appendChild(n)})}catch(t){e.innerHTML='<div class="text-red-500 text-sm">Error loading teacher off days</div>'}},async deleteOffDay(e){if(confirm("Are you sure you want to delete this off day record?"))try{await c.delete("offDays",e),await this.renderOffDaysList()}catch(e){alert("Error: "+e.message)}},async deleteTeacherOffDay(e){if(confirm("Are you sure you want to delete this teacher off day record?"))try{await c.delete("teacherOffDays",e),await this.renderTeacherOffDaysList()}catch(e){alert("Error: "+e.message)}},async handleTeacherUpload(t){const a=t.target.files[0];if(!a)return;const n=document.getElementById("teacher-upload-status");n.classList.remove("hidden"),n.innerHTML='<i class="fas fa-spinner fa-spin"></i> Reading Excel file...',n.className="mb-2 p-2 bg-blue-50 border border-blue-200 rounded text-sm";try{const s=await a.arrayBuffer(),r=XLSX.read(s,{type:"array"});let i=null,l=null,m=[];for(const e of r.SheetNames){const t=r.Sheets[e],a=XLSX.utils.sheet_to_json(t);if(a.length>0){const n=Object.keys(a[0]),s=n.some(e=>e.toLowerCase().includes("id")&&!e.toLowerCase().includes("name")),r=n.some(e=>e.toLowerCase().includes("name")||e.toLowerCase().includes("teacher"));if(s&&r){i=t,l=e,m=a;break}}}if(i||(l=r.SheetNames[0],i=r.Sheets[l],m=XLSX.utils.sheet_to_json(i)),0===m.length)throw new Error("No data found in Excel file");n.innerHTML=`<i class="fas fa-spinner fa-spin"></i> Found ${m.length} rows. Processing...`;const h=Object.keys(m[0]);let u=null,f=null;for(const e of h){const t=e.toLowerCase().trim();!t.includes("id")||t.includes("name")||u||(u=e),t.includes("name")&&!f&&(f=e)}if(!u||!f)throw new Error("Could not find Teacher ID and Name columns. Please ensure your Excel file has these columns.");const g=await c.get("teachers"),y=new Set(g.map(e=>e.id)),p=this.getTodayDate(),x=(new Date).toISOString();let w=0,v=0,b=0,E=0;for(let t=0;t<m.length;t++){const a=m[t],n=String(a[u]||"").trim(),s=String(a[f]||"").trim();if(!n&&!s){b++;continue}if(!n){b++;continue}if(!s){b++;continue}const r={id:n,name:s,subject:a.Subject||a.subject||"General",dateAdded:p,createdAt:x};try{await d(o(e,"teachers",n),r),y.has(n)?v++:w++,y.add(n)}catch(e){E++}}c.cache.teachers=null,await this.renderAdmin(),n.className="mb-2 p-2 bg-green-50 border border-green-200 rounded text-sm text-green-800",n.innerHTML=`\n                <i class="fas fa-check-circle"></i> \n                <strong>Import Complete!</strong><br>\n                ‚úÖ Imported: ${w} | üîÑ Updated: ${v} | ‚è≠Ô∏è Skipped: ${b} | ‚ùå Errors: ${E}\n            `,t.target.value=""}catch(e){n.className="mb-2 p-2 bg-red-50 border border-red-200 rounded text-sm text-red-800",n.innerHTML=`<i class="fas fa-exclamation-circle"></i> <strong>Error:</strong> ${e.message}`,t.target.value=""}}};window.app=l,document.addEventListener("DOMContentLoaded",()=>{l.init()});